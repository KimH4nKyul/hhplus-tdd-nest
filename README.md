## β“ [κ³Όμ ] `point` ν¨ν‚¤μ§€μ TODO μ™€ ν…μ¤νΈμ½”λ“λ¥Ό μ‘μ„±ν•΄μ£Όμ„Έμ”.

**μ”κµ¬ μ‚¬ν•­**

- PATCH `/point/{id}/charge` : ν¬μΈνΈλ¥Ό μ¶©μ „ν•λ‹¤.
- PATCH `/point/{id}/use` : ν¬μΈνΈλ¥Ό μ‚¬μ©ν•λ‹¤.
- GET `/point/{id}` : ν¬μΈνΈλ¥Ό μ΅°νν•λ‹¤.
- GET `/point/{id}/histories` : ν¬μΈνΈ λ‚΄μ—­μ„ μ΅°νν•λ‹¤.
- μ”κ³ κ°€ λ¶€μ΅±ν•  κ²½μ°, ν¬μΈνΈ μ‚¬μ©μ€ μ‹¤ν¨ν•μ—¬μ•Ό ν•©λ‹λ‹¤.
- <mark style="background: #FF5582A6;">λ™μ‹μ— μ—¬λ¬ κ±΄μ ν¬μΈνΈ μ¶©μ „, μ΄μ© μ”μ²­μ΄ λ“¤μ–΄μ¬ κ²½μ° μμ°¨μ μΌλ΅ μ²λ¦¬λμ–΄μ•Ό ν•©λ‹λ‹¤.</mark>

---

## ν”„λ΅μ νΈ κµ¬μ΅° λ¶„μ„

### κΈ°λ³Έ μ •λ³΄

```text
π“¦src
β”£ π“‚database
β”ƒ β”£ π“database.module.ts
β”ƒ β”£ π“pointhistory.table.ts
β”ƒ β”— π“userpoint.table.ts
β”£ π“‚point
β”ƒ β”£ π“point.controller.ts
β”ƒ β”£ π“point.dto.ts
β”ƒ β”£ π“point.model.ts
β”ƒ β”— π“point.module.ts
β”£ π“app.controller.spec.ts
β”£ π“app.controller.ts
β”£ π“app.module.ts
β”£ π“app.service.ts
β”— π“main.ts
```

μ‹μ‘ ν”„λ΅μ νΈ λ””λ ‰ν† λ¦¬ κµ¬μ΅°λ” μ„μ™€ κ°™μ΄ `point`μ™€ `database`μ΄λ‹¤.
μ—¬κΈ°μ„ `database` λ””λ ‰ν† λ¦¬μ `*.table.ts`λ“¤μ€ λ³€κ²½λμ–΄μ„  μ•λλ©°, κ³µκ° APIλ¥Ό μ‚¬μ©ν•΄ κΈ°λ¥μ„ κ²€μ¦ν•΄μ•Ό ν•λ‹¤.

![](https://i.imgur.com/AnSKQMk.png)

λ‹¤μ΄μ–΄κ·Έλ¨μ„ ν™•μΈν•΄ λ³΄λ©΄, `PointController`λ¥Ό λ€μƒμΌλ΅ ν…μ¤νΈ μ¤μ„νΈλ¥Ό λ§λ“¤μ–΄ TDDλ¥Ό μ§„ν–‰ν•΄μ•Ό ν•λ‹¤.
κ·Έλ¦¬κ³  `PointController`μ™€ μ»¨νΈλ΅¤λ¬κ°€ μ‚¬μ©ν•λ” Table λ¨λ“λ“¤μ„ λ€μƒμΌλ΅ λ‹¨μ„ ν…μ¤νΈλ¥Ό μ‘μ„±ν•  κ²ƒμ΄λ‹¤.

---

## ν…μ¤νΈ μ½”λ“ μ‘μ„±

### PointControllerκ°€ μ‚¬μ©ν•λ” Table λ¨λ“μ— λ€ν• ν…μ¤νΈ

1. ν…μ¤νΈ μ‹¤ν–‰

```bash
# pointhistory.table

npm run test pointhistory

# userpoint.table

npm run test userpoint
```

2. ν…μ¤νΈ λ©λ΅

- `userpoint.table.ts`

```
β μ μ € ν¬μΈνΈ ν…μ΄λΈ”μ—μ„ ν¬μΈνΈλ¥Ό κ°€μ Έμ¬ μ μ—†μ - μ¬λ°”λ¥΄μ§€ μ•μ€ ID κ°’
β­•οΈ μ μ € ν¬μΈνΈ ν…μ΄λΈ”μ— μ…λ ¥ν•  μ μμ
β­•οΈ μ μ € ν¬μΈνΈ ν…μ΄λΈ”μ— μ—…λ°μ΄νΈν•  μ μμ
β­•οΈ μ μ € ν¬μΈνΈ ν…μ΄λΈ”μ—μ„ ν¬μΈνΈλ¥Ό κ°€μ Έμ¬ μ μμ
```

- `pointhistory.table.spec.ts`

```
β­•οΈ ν¬μΈνΈ νμ¤ν† λ¦¬ ν…μ΄λΈ”μ— μ…λ ¥ν•  μ μμ
β­•οΈ ν¬μΈνΈ νμ¤ν† λ¦¬ ν…μ΄λΈ”μ—μ„ νμ¤ν† λ¦¬λ¥Ό κ°€μ Έμ¬ μ μμ
```

### PointController ν…μ¤νΈ

1. ν…μ¤νΈ μ‹¤ν–‰

```bash
npm run test point.controller
```

2. ν…μ¤νΈ λ©λ΅

- `point.controller.spec.ts`

```
β ν¬μΈνΈλ¥Ό μ¶©μ „ν•  μ μ—†μ - ν¬μΈνΈκ°€ 0λ³΄λ‹¤ μ‘μ
β ν¬μΈνΈλ¥Ό μ¶©μ „ν•  μ μ—†μ - μ¬λ°”λ¥΄μ§€ μ•μ€ ID κ°’
β­•οΈ ν¬μΈνΈλ¥Ό μ¶©μ „ν•  μ μμ
β ν¬μΈνΈλ¥Ό μ‚¬μ©ν•  μ μ—†μ - μ¬λ°”λ¥΄μ§€ μ•μ€ ID κ°’
β ν¬μΈνΈλ¥Ό μ‚¬μ©ν•  μ μ—†μ - ν¬μΈνΈκ°€ 0λ³΄λ‹¤ μ‘μ
β ν¬μΈνΈλ¥Ό μ‚¬μ©ν•  μ μ—†μ - μ‚¬μ©ν•  μ μλ” ν¬μΈνΈκ°€ μ—†κ±°λ‚ μ μ
β­•οΈ ν¬μΈνΈλ¥Ό μ‚¬μ©ν•  μ μμ
β ν¬μΈνΈλ¥Ό μ΅°νν•  μ μ—†μ - μ¬λ°”λ¥΄μ§€ μ•μ€ ID κ°’
β­•οΈ ν¬μΈνΈλ¥Ό μ΅°νν•  μ μμ
β ν¬μΈνΈ μ¶©μ „/μ΄μ© λ‚΄μ—­μ„ μ΅°νν•  μ μ—†μ - μ¬λ°”λ¥΄μ§€ μ•μ€ ID κ°’
β ν¬μΈνΈ μ¶©μ „/μ΄μ© λ‚΄μ—­μ„ μ΅°νν•  μ μ—†μ - λ‚΄μ—­μ΄ μ—†μ
β­•οΈ ν¬μΈνΈ μ¶©μ „/μ΄μ© λ‚΄μ—­μ„ μ΅°νν•  μ μμ
β… ν¬μΈνΈ μ¶©μ „/μ΄μ©μ— λ€ν• λ™μ‹ μ”μ²­μ„ μμ°¨μ²λ¦¬ ν•  μ μμ
```

---

## End(1).

> β“ λ™μ‹μ— μ—¬λ¬ κ±΄μ ν¬μΈνΈ μ¶©μ „/μ΄μ© μ”μ²­μ΄ λ“¤μ–΄μ¬ κ²½μ° μμ°¨μ μΌλ΅ μ²λ¦¬λμ–΄μ•Ό ν•λ‹¤.

μ„ λ¬Έμ μ— λ€ν•΄ μ λ€λ΅ μ΄ν•΄λ¥Ό ν•μ§€ λ»ν•κ±° κ°™λ‹¤. μƒκ°ν–λ λ°©μ•μ€ (1) λ©”λ¨λ¦¬νλ¥Ό κµ¬ν„ν•΄ λ™μ‹ μ”μ²­μ— λ€ν• μμ°¨ μ²λ¦¬μ™€ (2) μ‚¬μ©μκ°€ μμ°¨μ (μ¶©μ „ > μ”μ²­ μμ„)μΌλ΅ μ”μ²­ν•λ‹¤κ³  κ°€μ •ν•κ³  `Promise.all`λ΅ λ³‘λ ¬μ²λ¦¬ ν•λ” λ°©μ‹μ„ μƒκ°ν–μ—λ‹¤.

ν…μ¤νΈλ” ν›„μλ¥Ό νƒν•΄ μ‘μ„± ν–λ”λ°, λ¬Έμ λ¥Ό μ λ€λ΅ μ΄ν•΄ν•κΈ° μ„ν•΄ λ©ν† λ‹κ» μ—¬μ­¤λ³΄κ³  λ¦¬ν©ν† λ§μ„ μ§„ν–‰ν•΄μ•Ό ν•  κ±° κ°™λ‹¤.

### Insight.

> β—οΈ λ©ν† λ§μ„ ν†µν•΄ `Node.js`μ λΉ„λ™κΈ° ν¨λ¬λ‹¤μ„μ„ μ•κ³ , `async-mutex`λ΅ λ™μ‹μ„±/λ™κΈ°ν™” λ¬Έμ λ¥Ό ν•΄κ²°ν•  μ μμμ„ μ•κ² λμ—λ‹¤.

κ·Έλ ‡μ§€λ§ `Mutex`λ¥Ό ν™μ©ν•λ©΄μ„ μ”μ²­μ΄ λ¬΄ν•ν λ€κΈ°ν•λ” μƒν™©μ„ ν”Όν•κΈ° μ„ν•΄ νƒ€μ„μ•„μ›ƒμ„ μ„¤μ •ν–λ”λ°, μ΄λ¥Ό λ³΄ν†µ μ–Όλ§ μ •λ„λ΅ μ„¤μ •μ„ ν•΄μ•Ό ν•λ”μ§€, μµμ ν™” λ°©μ•μ΄ μλ‹¤λ©΄ κΈ°μ¤€μ΄ λλ” μ§€ν‘λ” λ¬΄μ—‡μΈμ§€ μ•κ³  μ‹¶λ‹¤.

---

## Plan.

### λ¦¬ν©ν† λ§ κ³„ν

- [x] μ»¨νΈλ΅¤λ¬λ” μ”μ²­μ„ λ°›μ•„ λ“¤μ΄κ³  μ‘λ‹µμ„ μ£Όλ” μ—­ν• λ§ ν•΄μ•Ό ν•λ‹¤.
- [x] λ”°λΌμ„ μ»¨νΈλ΅¤λ¬μ— ν¬ν•¨λ ν”„λ΅μ„Έμ¤λ” λ¨λ‘ μ„λΉ„μ¤ κ³„μΈµμΌλ΅ μ®κΈ΄λ‹¤.
- [x] μ„λΉ„μ¤ κ³„μΈµμ€ λ‹¤μ‹ ν¬μΈνΈλ¥Ό μ΅°νν•λ” μ—­ν• μ„ ν•λ” μ»΄ν¬λ„νΈμ™€ μ—…λ°μ΄νΈ μ—­ν• μ„ ν•λ” μ»΄ν¬λ„νΈλ΅ λ‚λλ‹¤.
- [x] μ½”λ“λ¥Ό λ³€κ²½ν•  λ• λ§λ‹¤ ν…μ¤νΈ μ½”λ“λ¥Ό μ‹¤ν–‰ν•΄ μ •μƒ λ™μ‘ν•λ” μ§€λ¥Ό κ²€μ¦ν•λ‹¤.
- [x] ~~μμ°¨ μ²λ¦¬λ¥Ό μ„ν• λ©”λ¨λ¦¬ νλ¥Ό ν…μ¤νΈ μ½”λ“λ¥Ό ν†µν•΄ κµ¬ν„ν•λ‹¤.~~ ==_λ©”λ¨λ¦¬νκ°€ μ•„λ‹ λ®¤ν…μ¤λ¥Ό ν™μ©_==
- [x] μ¶©λ¶„ν ν…μ¤νΈ ν•κ³  κµ¬ν„μ΄ μ™„λ£λλ©΄ ν…μ¤νΈ μ½”λ“μ—μ„ μ‹¤μ  κµ¬ν„μ„ λ¶„λ¦¬ν•λ‹¤.
- [x] λ°μ΄ν„°λ² μ΄μ¤ κ³„μΈµμ κ²½μ°μ—λ” λ‹¤λ¥Έ λ°μ΄ν„°λ² μ΄μ¤λ΅ κµμ²΄ν•  κ²½μ°λ¥Ό μ„ν•΄ μμ΅΄μ„±μ„ μ—­μ „ν•λ‹¤.

---

## After.

### λ³€κ²½λ ν”„λ΅μ νΈ κµ¬μ΅°

```
π“¦src
 β”£ π“‚constants
 β”ƒ β”— π“timeout.ts
 β”£ π“‚database
 β”ƒ β”£ π“database.module.ts
 β”ƒ β”£ π“pointhistory.table.spec.ts
 β”ƒ β”£ π“pointhistory.table.ts
 β”ƒ β”£ π“userpoint.table.spec.ts
 β”ƒ β”— π“userpoint.table.ts
 β”£ π“‚point
 β”ƒ β”£ π“‚controller
 β”ƒ β”ƒ β”£ π“‚dtos
 β”ƒ β”ƒ β”ƒ β”— π“point.dto.ts
 β”ƒ β”ƒ β”£ π“point.controller.spec.ts
 β”ƒ β”ƒ β”— π“point.controller.ts
 β”ƒ β”£ π“‚model
 β”ƒ β”ƒ β”— π“point.model.ts
 β”ƒ β”£ π“‚repository
 β”ƒ β”ƒ β”£ π“point.memory.repository.ts
 β”ƒ β”ƒ β”£ π“point.repository.spec.ts
 β”ƒ β”ƒ β”— π“point.repository.ts
 β”ƒ β”£ π“‚service
 β”ƒ β”ƒ β”£ π“point.handler.ts
 β”ƒ β”ƒ β”£ π“point.reader.ts
 β”ƒ β”ƒ β”— π“point.service.ts
 β”ƒ β”— π“point.module.ts
 β”£ π“app.module.ts
 β”— π“main.ts
```

### λ³€κ²½λ λ μ΄μ•„μ›ƒ

![](https://i.imgur.com/sqofoBv.png)

---

## End(2).

λ‹¨μ„ ν…μ¤νΈλ§ μ‘μ„±ν•κ³  μ μ¶ν•΄μ„ μ•„μ‰½λ‹¤. ν•μ§€λ§ λ‹¨μ„ ν…μ¤νΈλ¥Ό ν†µν•΄ TDDλ¥Ό μ§„ν–‰ν•λ©΄μ„ μ”κµ¬μ‚¬ν•­μ„ λ§μ΅±ν•  μ μμ—κ³ , μ–΄λμ •λ„ TDDμ— λ€ν• κ°μ„ μ΅μ„ μ μλ” μΆ‹μ€ κΈ°νμ€λ‹¤.

μ΄ ν”„λ΅μ νΈλ” ν†µν•© ν…μ¤νΈ, E2E ν…μ¤νΈκΉμ§€ κ°μΈμ μΌλ΅ μ™„λ£ν•΄ λ³Ό μƒκ°μ΄λ‹¤.

μ΄μ  2μ£Όμ°¨ λ°μ  λ‚΄μ©μ„ μ—΄μ‹¬ν λ“£κ³ , μƒλ΅μ΄ κ³Όμ μ— λμ…ν•  μ°¨λ΅€λ‹¤!
